= Module 01: VM Foundations with OpenShift Lightspeed

include::vars.adoc[]

== OpenShift Virtualization introduction and feature review

OpenShift Virtualization provides scalable, enterprise-grade virtualization functionality as a feature in Red Hat OpenShift. You can use it to manage virtual machines (VMs) exclusively or alongside container workloads.

image::rh1/02-ocp-virt-arch.png["OpenShift Virtualization architecture diagram showing VM and container workloads on OpenShift", link="self", window=blank, width="100%"]

OpenShift Virtualization adds new objects into your OpenShift Container Platform cluster by using Kubernetes custom resources to enable virtualization tasks. These tasks include:

* Creating and managing Linux and Windows VMs
* Running pod and VM workloads alongside each other in a cluster
* Connecting to VMs through a variety of consoles and CLI tools
* Importing and cloning existing VMs
* Managing network interface controllers and storage disks attached to VMs
* Live migrating VMs between nodes


== Objectives

* The attendee will participate in a brief review of OpenShift Virtualization features.
* The attendee will create a simple VM by reviewing provisioning options available in OpenShift Virtualization.
* The attendee will create a custom VM by providing instructions to OpenShift Lightspeed for assistance.
* The attendee will troubleshoot a VM deployment failure using OpenShift Lightspeed.

[[explore-openshift-virt]]
== Getting started with OpenShift Virtualization

Log into your console with the username and password provided in the introduction section.

You will be welcomed to the new OpenShift UI, please click on *Skip tour* on this window.

image::rh1/03-welcome-to-openshift.png["OpenShift welcome screen with Skip tour option highlighted", link="self", window=blank, width="100%"]

Also, you may notice that the *OpenShift Lightspeed* window is taking up a significant amount of console real estate on initial launch, please minimize this window for now until we are ready to use it.

image::rh1/04-minimize-lightspeed.png["OpenShift Lightspeed window with minimize button highlighted", link="self", window=blank, width="100%"]

Please note that you have a dedicated set of projects for your user account to make use of during this lab as well as access to the default project for openshift-virtualization-os-images allowing you to access default virtual machine images.

image::rh1/05-user-project-list.png["Project dropdown showing user-dedicated projects and openshift-virtualization-os-images", link="self", window=blank, width="100%"]

Navigate to the OpenShift Virtualization console by clicking on *Virtualization -> VirtualMachines* in the left-side navigation menu.

image::rh1/06-virt-navigation.png["Left-side navigation menu with Virtualization and VirtualMachines selected", link="self", window=blank, width="100%"]

Click on the *{user}-travel-agency* namespace in the center column to see that there are already a number of virtual machines running in the cluster.

image::rh1/07-vms-overview.png["VirtualMachines list in the travel-agency project showing running VMs", link="self", window=blank, width="100%"]

We will now explore some default configurations and metrics from a running VM.

Click on the VM named *cars-vm*, this directs you to the VM Overview page.

On this page you will find:

- Other tabs dedicated to Metrics, Configuration, Events, and other useful tools in tabs near the top. 
- State management buttons and the dropdown Actions menu in the top-right.
- Basic utilization information metrics in the bottom-center.

image::rh1/08-cars-vm-detail.png["cars-vm Overview page showing status, utilization metrics, and Actions menu", link="self", window=blank, width="100%"]

For a deeper look at metrics, click on the `Metrics` tab. 

This gives you an overview of the VM metrics like memory and CPU consumption, storage and networking performance data if you scroll down the page.

image::rh1/09-cars-vm-metrics.png["Metrics tab showing CPU and memory usage graphs for cars-vm", link="self", window=blank, width="100%"]

From this page we can even dig a bit deeper by using a default Grafana dashboard that has been configured for us to view virtual machine metrics.

Access it by clicking on the *Virtualization dashboard* link in the top right corner.

image::rh1/09a-cars-vm-dashboard-link.png["Metrics tab with Virtualization dashboard link highlighted in the top right", link="self", window=blank, width="100%"]

This will provide us with a dashboards page that shows various fields of curated information such as *Top Consumers of Memory*, *Top Consumers of CPU*, and other information commonly sought after in graphic formats like *Storage IOPS Usage by Virtual Machines* and *Network Traffic by Virtual Machines* over time.

image::rh1/09b-cars-vm-dashboard-cpumem.png["Grafana dashboard showing Top Consumers of CPU and Memory for virtual machines", link="self", window=blank, width="100%"]

image::rh1/09c-cars-vm-dashboard-stornet.png["Grafana dashboard showing Storage IOPS and Network Traffic graphs for virtual machines", link="self", window=blank, width="100%"]

If we return to our virtual machine overview by clicking on `Virtualization -> VirtualMachines`, and click back on our `cars-vm` we can take a deeper look at the configuration options that can be modified on the VM, by clicking on the `Configuration` tab.

This gives you an overview of the VM configuration options that can be modified including CPU and Memory, as well as Storage, Networking, and Scheduling options that are available in the sub menus. Feel free to click through these menus to see the tunable options that are available to you.

image::rh1/10-cars-vm-config.png["Configuration tab showing CPU, Memory, Storage, Networking, and Scheduling options for cars-vm", link="self", window=blank, width="100%"]

In this introduction section we have explored the Virtualization Dashboard in the OpenShift console and the sub-tabs for Metrics, default Dashboards, and virtual machine Configuration. Now we will proceed with additional tasks in OpenShift to create and work with a virtual machine.


[[quick-create-vm]]
== Quick create a virtual machine

Begin this task by creating a project to organize the virtual machines you will be creating in this and the following sections.

Click on the `Create Project` button in the center column.

image::rh1/11-create-project-button.png["Create Project button highlighted in the OpenShift console", link="self", window=blank, width="100%"]

A new window will launch, name your project {user}-vms, leave the other fields blank, and click on the `Create` button.

image::rh1/12-create-project-window.png["Create Project dialog with project name field filled in", link="self", window=blank, width="100%"]

NOTE: The images in this guide will be static to the user that they were captured under, but the instructions should be dynamic to your particular user account. Please be sure to create things as your designated user.

You will be placed in this new project after it is created. Click the `Create VirtualMachine` button in the middle, and select `From template` from the dropdown menu to create your virtual machine.

image::rh1/13-create-vm-button.png["Create VirtualMachine button with From template dropdown option", link="self", window=blank, width="100%"]

You will see the templates for both Linux and Windows VMs that are available to you arranged in a number of tiles. Click on the `Red Hat Enterprise Linux 9 VM` tile to create a RHEL9 VM.

image::rh1/14-template-catalog.png["VM template catalog showing Linux and Windows template tiles including Red Hat Enterprise Linux 9", link="self", window=blank, width="100%"]

A new window will appear allowing you to configure things like a bootable CD image, modify the disk size of the VM, and configure its CPU and Memory resources as well as name the VM. For the purpose of this exercise, just name the virtual machine `{user}-rhel9` and click the `Quick create VirtualMachine` button at the bottom.

image::rh1/15-quick-create-vm.png["Quick create VM dialog with name field and Quick create VirtualMachine button", link="self", window=blank, width="100%"]

You will be taken to the VirtualMachine details page with the `Overview` tab just as before where you will see the VM enter the `Provisioning` stage, followed by the `Starting` and finally the `Running` stage when it is up and ready.

image::rh1/16-quick-create-vm-overview.png["VM Overview page showing the new VM progressing through Provisioning to Running state", link="self", window=blank, width="100%"]

You can click on `Console` tab to see that the machine is running.

image::rh1/17-quick-create-vm-console.png["Console tab showing the running RHEL9 virtual machine", link="self", window=blank, width="100%"]


[[lightspeed-intro]]
== Introduction to OpenShift Lightspeed

For those unfamiliar, https://www.redhat.com/en/technologies/cloud-computing/openshift/lightspeed[OpenShift Lightspeed^] is a generative AI-powered assistant integrated directly into the Red Hat OpenShift web console that can help users troubleshoot, understand, and manage OpenShift clusters by answering questions, suggesting commands, and analyzing YAML configurations through natural language, connecting with various large language models (LLMs) for tailored assistance. 

For the rest of this module, we are going to make use of OpenShift Lightspeed, to help us perform several tasks in our cluster, from information gathering, to the creation and troubleshooting of resources.


[[getting-started-lightspeed]]
== Getting started with OpenShift Lightspeed

Continuing from where we left off, you may recall that we minimized the OpenShift Lightspeed menu when we started the previous section. You can re-open its console by clicking on the icon in the bottom right corner of the screen.

image::rh1/18-lightspeed-icon.png["OpenShift Lightspeed icon in the bottom right corner of the console", link="self", window=blank, width="100%"]

The lightspeed window will re-appear. And you can start by asking it basic informative questions about your cluster and the workloads running in it.

Start by performing a copy/paste action on the following question, and click the `Send` button when ready.

[source,shell,subs=attributes,role=execute]
----
How many virtual machines are running in the {user}-vms project?
----

image::rh1/19-lightspeed-question-one.png["Lightspeed chat window with the question about running VMs pasted in", link="self", window=blank, width="100%"]

After a few moments, OpenShift Lightspeed should report that there is `one` VM running in that project, which is the one we quick created a moment ago.

It can also tell you where it got this information from, and gives you the opportunity to rate its reply.

image::rh1/20-lightspeed-answer-one.png["Lightspeed response confirming one VM is running in the project", link="self", window=blank, width="100%"]

Go ahead and give it a `thumbs up` if you are happy with the response, it will also give you the opportunity to provide additional feedback. Click the `Submit` button. This feedback can be used to help train the model for its responses in the future.

image::rh1/21-lightspeed-thumbs-up.png["Lightspeed feedback dialog with thumbs up selected and Submit button", link="self", window=blank, width="100%"]

Now let us ask it a follow-up question, copy/paste the following question, and click the `Send` button when ready.

[source,shell,subs=attributes,role=execute]
----
What operating system is that VM running?
----

image::rh1/22-lightspeed-question-two.png["Lightspeed chat with follow-up question about the VM operating system", link="self", window=blank, width="100%"]

After a few moments, OpenShift Lightspeed will correctly answer that the VM in question is a `RHEL9` VM.

image::rh1/23-lightspeed-answer-two.png["Lightspeed response identifying the VM as running RHEL9", link="self", window=blank, width="100%"]

NOTE: Notice that OpenShift Lightspeed can continue a series of questions by inferring information from those previously asked. In this example, we did not have to restate the project, or tell it specifically which VM we were referring to in the second prompt.

Feel free to play with OpenShift Lightspeed at your leisure, by asking it other questions. Note that some information about the overall cluster may not be available to your {user} account and the permissions granted to it.

When you are finished, click the `x` icon in the top right corner to clear the OpenShift Lightspeed prompt history.

image::rh1/24-clear-lightspeed-history.png["Lightspeed window with the X icon to clear chat history highlighted", link="self", window=blank, width="100%"]

Click the `Erase and start new chat` button to be ready to move along to the next task in this module with a fresh conversation.

image::rh1/25-erase-and-start-new-chat.png["Confirmation dialog with Erase and start new chat button", link="self", window=blank, width="100%"]

[[create-vm-lightspeed]]
== Create a VM from an OpenShift Lightspeed prompt

Quick creating a VM as we did earlier in this module is one thing; it shows customers that OpenShift Virtualization essentially "works", and it demonstrates that we can answer their most basic questions often concerning ease of use, or how the user experience differs from what they are used to from their current hypervisor.

A real use case for a VM often involves customization and configuration of not just the virtual machine itself but of the workloads that it hosts, or essentially the purpose of the VM. This is where a tool like OpenShift Lightspeed can assist by enabling those unfamiliar with the platform to perform actions in an accelerated fashion.

In addition to answering questions about your OpenShift cluster and the workloads running there, OpenShift Lightspeed can also be used to help create resources. While it currently does not have the capability of performing cluster management operations on its own, it can provide example configurations that can be used to perform those actions.

In this task we will provide a prompt to OpenShift Lightspeed to ask it to help us create a virtual machine for a specific purpose. Once it responds, we will use what it provides to create the virtual machine that we need.

=== Create a prompt for the VM

Our task is to create a virtual machine that serves as a database server by default without additional configuration by the end user.

////
Before we get started, lets ensure that we are logged into our cluster via CLI so that we can perform the actions that OpenShift Lightspeed recommends

Login to the console on the right of the Showroom using the following command:

[source,shell,subs=attributes,role=execute]
----
{login_command}
----

image::rh1/26-terminal-login.png[link="self", window=blank, width="100%"]

Use the following command to set the project to the {user}-vms project:

[source,shell,subs=attributes,role=execute]
----
oc project {user}-vms
----

image::rh1/27-terminal-project.png[link="self", window=blank, width="100%"]

With that complete, we can return to our console window and start working with OpenShift Lightspeed!
////

Copy/Paste the following prompt into OpenShift Lightspeed and click the `Send` button when you are ready.

[source,shell,subs=attributes,role=execute]
----
Create a YAML manifest that creates a VM in the {user}-vms project that has CentOS Stream 9 as its operating system, to be used as a database-server. Configure it with a username and password through cloudinit, and automatically install mariadb and configure it to run on startup.
----

image::rh1/28-create-vm-prompt.png["Lightspeed chat with the database server VM creation prompt pasted in", link="self", window=blank, width="100%"]

OpenShift Lightspeed will respond with with a YAML manifest that can be used to create the VM we have requested and its rationale for providing its answer.

image::rh1/29-create-vm-answer.png["Lightspeed response with a YAML manifest for the database server VM", link="self", window=blank, width="100%"]

NOTE: Due to the nature of generative AI, there is a chance that your response does not look exactly like that provided in the screenshot above.

The YAML provided should look similar to the following:

[source,yaml,subs=attributes,role=execute]
----
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: database-server
  namespace: {user}-vms
spec:
  running: true
  template:
    metadata:
      labels:
        kubevirt.io/vm: database-server
    spec:
      domain:
        cpu:
          cores: 2
        devices:
          disks:
          - name: rootdisk
            disk:
              bus: virtio
          - name: cloudinitdisk
            disk:
              bus: virtio
        resources:
          requests:
            memory: 4Gi
      volumes:
      - name: rootdisk
        containerDisk:
          image: quay.io/containerdisks/centos-stream:9
      - name: cloudinitdisk
        cloudInitNoCloud:
          userData: |-
            #cloud-config
            user: dbadmin
            password: dbpassword
            chpasswd: { expire: False}
            packages:
              - mariadb-server
            runcmd:
              - systemctl enable mariadb
              - systemctl start mariadb
----

After copying the YAML above, you can use the OpenShift Quick Create button to deploy the VM.

Click on the Quick Create button at the top of the console, and select `Import YAML` from the dropdown menu.

image::rh1/30-quick-create-yaml.png["Quick Create button dropdown with Import YAML option highlighted", link="self", window=blank, width="100%"]

Paste the YAML manifest provided and click the `Create` button at the bottom.

image::rh1/31-paste-yaml.png["Import YAML editor with the VM manifest pasted and Create button at bottom", link="self", window=blank, width="100%"]

The VM should start provisioning and after a few moments it will enter the `Running` state. You can see that it was placed in the {user}-vms namespace as directed, and is called database-server, and is running the CentOS Stream 9 operating system.

image::rh1/32-lightspeed-vm-running.png["database-server VM in Running state showing CentOS Stream 9 operating system", link="self", window=blank, width="100%"]

Click on the `Console` tab, and use the credentials to login, and verify that mariadb is installed, and running by using the following command:

[source,shell,subs=attributes,role=execute]
----
sudo mysql -u root
----

image::rh1/33-lightspeed-vm-console.png["VM console showing successful MariaDB login via sudo mysql -u root", link="self", window=blank, width="100%"]


[[troubleshoot-vm-lightspeed]]
== Troubleshoot a VM with OpenShift Lightspeed

In addition to answering basic questions about the platform, and generating configurations that can be used to deploy VMs or create other resources, OpenShift Lightspeed can also be used to troubleshoot issues with the platform and applications.

In this task we will configure a VM to fail on purpose, and then ask OpenShift Lightspeed if it can diagnose our issue to see what it says.

Ensure that you are in your `{user}-vms` project and click the `Create` button in the upper right corner and select the `From template` option from the dropdown menu.

image::rh1/34-create-vm-from-template.png["Create button with From template option in the dropdown menu", link="self", window=blank, width="100%"]

On the `Create new VirtualMachine` page select the tile for the Fedora VM.

image::rh1/35-fedora-tile.png["VM template catalog with the Fedora VM tile highlighted", link="self", window=blank, width="100%"]

When the Fedora VM dialog appears, name your virtual machine `fedora-broken` and click the button to `Customize VirtualMachine`.

image::rh1/36-customize-vm.png["Fedora VM dialog with name set to fedora-broken and Customize VirtualMachine button", link="self", window=blank, width="100%"]

On the `Customize and create VirtualMachine` page, click on the tab for `Disks` and next to the default rootdisk click on the `three-dot` menu and select the `Edit` option.

image::rh1/37-edit-disk.png["Disks tab with three-dot menu open and Edit option for the rootdisk", link="self", window=blank, width="100%"]

When the `Edit disk` dialog appears, change the disk size to *10GB*, which is too small to provision the VM correctly. Click the `Save` button on the dialog, and when returned to the main screen, click the `Create VirtualMachine` button.

image::rh1/38-edit-disk-small.png["Edit disk dialog with size changed to 10GB and Save button", link="self", window=blank, width="100%"]

NOTE: At this point it's likely to assume that a person unfamiliar with how boot images work in OpenShift Virtualization thinks that they have created a VM with a small hard disk to conserve storage space, and are confused as to why the VM won't successfully boot.

The VM will stay in the `Provisioning` state and will fail to progress.

image::rh1/39-vm-provisioning.png["fedora-broken VM stuck in Provisioning state", link="self", window=blank, width="100%"]

Clicking on the `Events` tab shows us that the DataVolume was created, and no additional information.

image::rh1/40-vm-events.png["Events tab showing DataVolume created event with no additional information", link="self", window=blank, width="100%"]

Putting ourselves in the shoes of our unfamiliar virtualization admin, this is where we ask OpenShift Lightspeed for help.

Click on the OpenShift Lightspeed icon in the bottom right corner, and ask it why the VM is unable to boot, and click the `Send` button.

[source,shell,subs=attributes,role=execute]
----
Why is the VM fedora-broken in the {user}-vms project failing to boot?
----

image::rh1/41-broken-lightspeed-prompt.png["Lightspeed chat with the question about why fedora-broken VM is failing to boot", link="self", window=blank, width="100%"]

OpenShift Lightspeed is able to diagnose the issue as storage-related, providing an error message about the DataVolume being smaller than necessary, and providing a potential resolution.

image::rh1/42-broken-lightspeed-answer.png["Lightspeed response diagnosing the storage issue and suggesting a resolution", link="self", window=blank, width="100%"]

NOTE: Due to the nature of generative AI, there is a chance that your response does not look exactly like that provided in the screenshot above.

IMPORTANT: Prior to moving on to the next section, to conserve resources and ensure a smooth lab experience, make sure that any of the VMs created in the *{user}-vms* project as a part of this module are shut down, and/or deleted. We will not be making use of them again.


== Conclusion

In this module we reviewed some fundamentals about virtual machines in OpenShift, and we have been introduced to OpenShift Lightspeed, and how it can be used to answer questions about our platform, and assist us with deploying and troubleshooting applications and VMs.
